
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-01-29
 Rendered using Maven Reflow Skin 1.0.0 (http://andriusvelykis.github.com/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Quick intro to MapDB internals | mapdb</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />
 
		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.2.2/cerulean/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/bootswatch.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/reflow-skin.css" rel="stylesheet" />
		
		<link href="http://yandex.st/highlightjs/7.3/styles/github.min.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/lightbox.css" rel="stylesheet" />
		
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/site.css" rel="stylesheet" />
		<link href="http://andriusvelykis.github.com/reflow-maven-skin//css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
<script src="js/excanvas.js"></script>
<script src="js/js-class.js"></script>
<script src="js/bluff.js"></script>
		<!-- Google Analytics -->
		<script type="text/javascript">
		
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-42074659-1']);
			_gaq.push(['_trackPageview']);

			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();

		</script>
		</head>

	<body class="page-doc-11-internals-quick-intro project-mapdb" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="../"><img src="images/logo.png" border="0" alt="MapDB"/> - java beyond heap</a>
					<div class="nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">MapDB <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="../index.html" title="Index">Index </a></li>
									<li><a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a></li>
									<li><a href="../features.html" title="Features">Features </a></li>
									<li><a href="../changelog.html" title="Changelog">Changelog </a></li>
									<li><a href="../credits.html" title="Credits">Credits </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">FAQ <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="../faq-general.html" title="General">General </a></li>
									<li><a href="../faq-problems.html" title="Problems">Problems </a></li>
									<li><a href="../faq-performance.html" title="Performance">Performance </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="../intro.html" title="Intro">Intro </a></li>
									<li><a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a></li>
									<li><a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a></li>
									<li><a href="../apidocs/index.html" title="JavaDoc">JavaDoc </a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Support <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a></li>
									<li><a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->
		<hr class="toc-separator" />
		<div id="toc-bar" class="navbar">
			<div class="navbar-inner">
				<div id="toc-scroll-target" class="container">
					<ul id="toc" class="nav">
						<li class="toplevel"><a href="#quick_intro_to_mapdb_internals" title="Quick intro to MapDB internals">Quick intro to MapDB internals</a></li>
						<li class="toplevel"><a href="#DBMaker_and_DB" title="DBMaker and DB">DBMaker and DB</a></li>
						<li class="toplevel"><a href="#Layers" title="Layers">Layers</a></li>
						<li class="toplevel"><a href="#Volume" title="Volume">Volume</a></li>
						<li class="toplevel"><a href="#Store" title="Store">Store</a></li>
						<li class="toplevel"><a href="#Engine_Wrappers" title="Engine Wrappers">Engine Wrappers</a></li>
						<li class="toplevel"><a href="#TxMaker" title="TxMaker">TxMaker</a></li>
						<li class="toplevel"><a href="#Collections" title="Collections">Collections</a></li>
						<li class="toplevel"><a href="#Serialization" title="Serialization">Serialization</a></li>
						<li class="toplevel"><a href="#Concurrency_patterns" title="Concurrency patterns">Concurrency patterns</a></li>
					</ul>
				</div>
			</div>
		</div>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1 id="quick_intro_to_mapdb_internals">Quick intro to MapDB internals</h1>
</div> 
<p>This chapter gives 5 minutes introduction to MapDB internal architecture. Rest of this manual assume that you have read this chapter.</p> 
<p>MapDB originally evolved as store for astronomical desktop application. As such it has a bit different design from most DBs. Major goal was to minimise overhead of any sort (garbage collection, memory, CPU, stack trace lengthâ€¦).</p> 
<p>Also serialization lifecycle is very different here. In most DB engines user has to serialize data himself and pass binary data into db. API than looks similar to this:</p> 
<div class="source"> 
 <pre>    engine.update(long recid, byte[] data);
</pre> 
</div> 
<p>But MapDB serializes data itself by using user supplied serializer:</p> 
<div class="source"> 
 <pre>    engine.update(long recid, Person data, Serializer&lt;Person&gt; serializer);
</pre> 
</div> 
<p>So serialization lifecycle is driven by MapDB rather than by user. This small detail is reason why MapDB is so flexible. For example <tt>update</tt> method could pass data-serializer pair to <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/AsyncWriteEngine.html">background-writer</a> thread and return almost instantly. Or <tt>Person</tt> instance could be stored in <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Caches.html">instance cache</a>, to minimise deserilization overhead on multiple reads. <tt>Person</tt> does not even have to be serialized, but could be stored in <tt>Map&lt;Long,Person&gt;</tt> map <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/StoreHeap.html">on heap</a>, in this case MapDB has speed comparable to Java Collections.</p> 
<div class="section"> 
 <h2 id="DBMaker_and_DB">DBMaker and DB</h2> 
 <p>90% of users will only need two classes from MapDB. <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/DBMaker.html">DBMaker</a> is builder style configurator which opens database. <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/DB.html">DB</a> represents store, it creates and opens collections, commits or rollbacks data.</p> 
 <p>MapDB collections use <tt>Engine</tt> (simple key-value store) to persist its data and state. Most of functionality comes from mixing <tt>Engine</tt> implementations and wrappers. For example off-heap store with asynchronous writes and instance cache could be instantiated by this pseudo-code: <tt> Engine engine = new Caches.HashTable( //instance cache new AsyncWriteEngine( //asynchronous writes new StoreWAL( //actual store with WAL transactions new Volume.MemoryVol() //raw buffer used for storage ))) </tt></p> 
 <p>Reality is even more complex since each wrapper takes extra parameters and there are more levels. So <tt>DBMaker</tt> is a factory which takes settings and wires all MapDB classes together.</p> 
 <p><tt>DB</tt> has similar role. It is too hard to load and instantiate collections manually (for example <tt>HTreeMap</tt> constructor takes 14 parameters). So <tt>DB</tt> stores all settings in Named Catalog and handles collections. Named Catalog is <tt>Map&lt;String,Object&gt;</tt> which is persisted in store at fixed recid and contains parameters for all other named collections and named records. To rename collection one just has to rename relevant keys in Named Catalog.</p> 
</div> 
<div class="section"> 
 <h2 id="Layers">Layers</h2> 
 <p>MapDB stack is little bit different from most DBs. It integrates instance cache and serialization usually found in ORM frameworks. On other side MapDB eliminated fixed-size page and disk cache.</p> 
 <p>From raw-files to <tt>Map</tt> interface it has following layers:</p> 
 <p>1) <b>Volume</b> - an <tt>ByteBuffer</tt> like abstraction over raw store. There are implementations for in-memory buffers or files.</p> 
 <p>2) <b>Store</b> - primitive key-value store (implementation of <tt>Engine</tt>). Key is offset on index table, value is variable length data. It has single transaction. Implementations are Direct, WAL, append-only and Heap (which does not use serialization). It performs serialization, encryption and compression.</p> 
 <p>3) <b>AsyncWriterEngine</b> - is optional <tt>Store</tt> (or <tt>Engine</tt>) wrapper which performs all modifications on background thread.</p> 
 <p>4) <b>Instance Cache</b> - is <tt>Engine</tt> wrapper which caches object instances. This minimises deserilization overhead.</p> 
 <p>5) <b>TxMaker</b> - is <tt>Engine</tt> factory which creates fake <tt>Engine</tt> for each transaction or snapshot. Dirty data are stored on heap.</p> 
 <p>6) <b>Collections</b> - such as TreeMap use <tt>Engine</tt> to store their data and state.</p> 
</div> 
<div class="section"> 
 <h2 id="Volume">Volume</h2> 
 <p><tt>ByteBuffer</tt> is best raw buffer abstraction Java has. However its size is limited by 31 bits addressing to 2GB. For that purpose MapDB uses <tt>Volume</tt> as raw buffer abstraction. It takes multiple <tt>ByteBuffer</tt>s and uses them together with 64bit addressing. Each <tt>ByteBuffer</tt> has 1GB size and represents <i>chunk</i>. IO operations which cross chunk boundaries are not supported (<tt>readLong(1GB-3)</tt> will throw an exception). It is responsibility of higher layer <tt>Store</tt> to ensure data do not overlap chunk boundaries.</p> 
 <p>MapDB provides some Volume implementations: heap buffers, direct (off-heap) buffers, memory mapped files and random access file. Each implementation fits different situation. For example memory mapped files have great performance, however 32bit desktop app will probably prefer random access files. All implementations share the same format, so it is possible to copy data (and entire store) between implementations.</p> 
 <p>User can also supply their own <tt>Volume</tt> implementations. For example each 1Gb chunk can be stored in separate file on multiple disks, to create software RAID. <tt>Volume</tt> could also handle duplication, binary snapshots (MapDB snapshots are at different layer) or raw disks.</p> 
</div> 
<div class="section"> 
 <h2 id="Store">Store</h2> 
 <p><a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Engine.html">Engine</a> (and <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Store.html">Store</a>) is primitive key-value store which maps recid (8-byte long record id) to some data (record). It has 4 methods for CRUD operations and 2 transaction methods:</p> 
 <div class="source"> 
  <pre>    long put(A, Serializer&lt;A&gt;)
    A get(long, Serializer&lt;A&gt;)
    void update(long, A, Serializer&lt;A&gt;)
    void delete(long, Serializer&lt;A&gt;)

    void commit()
    void rollback()
</pre> 
 </div> 
 <p>By default MapDB stack supports only single transaction. However there is wrapper <tt>TxMaker</tt> which stores un-commited data on heap and provides concurrent ACID transactions.</p> 
 <p><a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/DB.html">DB</a> is low level implementation of <tt>Engine</tt> which stores data on raw <tt>Volume</tt>. It usually has two files (or Volumes): index table and physical file. Recid (record ID) is usually fixed offset in index table, which contains pointer to physical file.</p> 
 <p>MapDB has multiple <tt>Store</tt> implementations, which differ in speed and durability guarantees. User can also supply their own implementation.</p> 
 <p>First (and default) is <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/StoreWAL.html">StoreWAL</a>. In this case Index Table contains record size and offset in physical file. Large records are stored as linked list. StoreWAL has free space management, so released space is reused. However over time it may require compaction. StoreWAL stores modifications in <i>Write Ahead Log</i>, which is sequence of simple instructions such as <i>write byte at this offset</i>. On commit (or reopen) WAL is replayed into main store, and discarded after successful file sync. On rollback the WAL is discarded.</p> 
 <p><a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/StoreDirect.html">StoreDirect</a> shares the same file format with <tt>StoreWAL</tt>, however it does not use write ahead log. Instead it writes data directly data into files and performs file sync on commit and close. This implementation trades any sort of data protection for speed, so data are usually lost if <tt>StoreDirect</tt> is not closed correctly (or synced after last write). Because there is no WAL, this store does not support rollback. This store is used if transactions are disabled.</p> 
 <p>Third implementation is <tt>StoreAppend</tt> which provides append-only file store. Because data are never overwritten, it is very solid and stable. However space usage skyrockets, since it stores all modifications ever made. TODO This store is not finished yet, so for example advanced compaction is missing. TODO Also all possibilities of this store are not explored (and documented yet). This store reads all data in sequence, in order to build Index Table which points to newest version of each record. The Index Table is stored on heap.</p> 
</div> 
<div class="section"> 
 <h2 id="Engine_Wrappers">Engine Wrappers</h2> 
 <p>Big part of features in MapDB is implemented as <tt>Engine</tt> wrappers. For example <tt>update</tt> method does not have modify file directly, but it can forward modification into <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/AsyncWriteEngine.html">background-writer</a></p> 
 <p>Also deserialized records can be stored in <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Caches.html">instance cache</a>, so it does not have to be deserialized on next read.</p> 
 <p>TODO expand Engine Wrappers section</p> 
</div> 
<div class="section"> 
 <h2 id="TxMaker">TxMaker</h2> 
 <p>MapDB <tt>Store</tt>s support only single transaction. So concurrent transactions needs to be serialized and commited one by one. For this there is <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/TxMaker.html">TxMaker</a>. It is factory which creates fake <tt>Engine</tt> for each transaction. Dirty (uncommited) data are stored on heap. Optimistic concurrency control is used to detect conflicts. <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/TxRollbackException.html">TxRollbackException</a> is thrown on write or commit, if current transaction was rolled back thanks to an conflict.</p> 
 <p>TxMaker has Serializable Isolation level, this level supports highest guarantees. Other isolation levels are not implemented, since author does not want to support (and explain) isolation problems.</p> 
 <p>TODO Current TxMaker uses global lock, so concurrent performance sucks. It will be rewritten after 1.0 release.</p> 
</div> 
<div class="section"> 
 <h2 id="Collections">Collections</h2> 
 <p>MapDB collection uses <tt>Engine</tt> as its parameter. There are two basic indexes:</p> 
 <p><a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/BTreeMap.html">BTreeMap</a> is ordered B-Linked-Tree. It offers great concurrent performance. It is best for small sized keys.</p> 
 <p><a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/HTreeMap.html">HTreeMap</a> is segmented Hash-Tree. It is good for large keys and values. It also supports entry expiration based on maximal size or time-to-live.</p> 
 <p>There also also <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Queues.html">Queues</a> and <a class="externalLink" href="http://www.mapdb.org/apidocs/org/mapdb/Atomic.html">Atomic</a> variables</p> 
 <p>TODO explain collections.</p> 
</div> 
<div class="section"> 
 <h2 id="Serialization">Serialization</h2> 
 <p>MapDB contains its own serialization framework. TODO explain serialization</p> 
</div> 
<div class="section"> 
 <h2 id="Concurrency_patterns">Concurrency patterns</h2> 
 <p>TODO concurrency patterns.</p> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">MapDB</li>
						<li>
							<a href="../index.html" title="Index">Index </a>
						</li>
						<li>
							<a href="http://www.github.com/jankotek/mapdb" title="Github" class="externalLink">Github </a>
						</li>
						<li>
							<a href="../features.html" title="Features">Features </a>
						</li>
						<li>
							<a href="../changelog.html" title="Changelog">Changelog </a>
						</li>
						<li>
							<a href="../credits.html" title="Credits">Credits </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">FAQ</li>
						<li>
							<a href="../faq-general.html" title="General">General </a>
						</li>
						<li>
							<a href="../faq-problems.html" title="Problems">Problems </a>
						</li>
						<li>
							<a href="../faq-performance.html" title="Performance">Performance </a>
						</li>
					</ul>
				</div>
				<div class="span2 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Documentation</li>
						<li>
							<a href="../intro.html" title="Intro">Intro </a>
						</li>
						<li>
							<a href="http://www.youtube.com/watch?v=FdZmyEHcWLI" title="Overview Video" class="externalLink">Overview Video </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/tree/master/src/test/java/examples" title="Examples" class="externalLink">Examples </a>
						</li>
						<li>
							<a href="../apidocs/index.html" title="JavaDoc">JavaDoc </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Support</li>
						<li>
							<a href="http://groups.google.com/group/mapdb" title="Mail list" class="externalLink">Mail list </a>
						</li>
						<li>
							<a href="https://github.com/jankotek/MapDB/issues" title="Bug tracker" class="externalLink">Bug tracker </a>
						</li>
						<li class="nav-header">Author</li>
						<li>
							<a href="http://www.kotek.net/" title="Blog" class="externalLink">Blog </a>
						</li>
						<li>
							<a href="http://www.twitter.com/jankotek" title="Twitter" class="externalLink">Twitter </a>
						</li>
						<li>
							<a href="mailto:jan@kotek.net" title="Email" class="externalLink">Email </a>
						</li>
						<li>
							<a href="http://www.kotek.net" title="About" class="externalLink">About </a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<blockquote><span class="color-highlight">MapDB</span> provides concurrent Maps, Sets and Queues backed by disk storage or off-heap memory.
It is a fast and easy to use embedded Java database engine. And it is completely free under Apache License.
MapDB is free as speech and free as beer under <a href="https://github.com/jankotek/MapDB/blob/master/license.txt">Apache License 2.0</a>.</blockquote>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014. All Rights Reserved.</p>
				<p class="version-date"><span class="projectVersion">Version: 0.9.10-SNAPSHOT. </span><span class="publishDate">Last Published: 2014-01-29. </span></p>
				<p><a href="http://github.com/andriusvelykis/reflow-maven-skin" title="Reflow Maven skin">Reflow Maven skin</a> by <a href="http://andrius.velykis.lt" target="_blank" title="Andrius Velykis">Andrius Velykis</a>.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->

	<!-- Fallback jQuery loading from Google CDN:
	     http://stackoverflow.com/questions/1014203/best-way-to-use-googles-hosted-jquery-but-fall-back-to-my-hosted-library-on-go -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript">
		if (typeof jQuery == 'undefined')
		{
			document.write(unescape("%3Cscript src='http://andriusvelykis.github.com/reflow-maven-skin//js/jquery-1.8.3.min.js' type='text/javascript'%3E%3C/script%3E"));
		}
	</script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/lightbox.js"></script>
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

	<script src="http://andriusvelykis.github.com/reflow-maven-skin//js/reflow-skin.js"></script>
	
	</body>
</html>
